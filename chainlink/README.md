# Chainlink

## Contracts

### Operator

There are two required contracts, `Operator.sol` and `APIConsumer.sol`.

As we are running on Avalanche that isn't currently officially support it was necessary to deploy our own instance of the `Operator.sol` contract. This is particularly necessary to support multi-parameter external adapters.

### APIConsumer

This contract provide the `request`/`fulfilment` functions needed by a Chainlink external adapter.

This `requestYouTubeAudioData` function receives the YouTube url parameter. This is recognised by a Chainlink node which in turn calls the custom external adapter.

Once the external adapter has performed its work it calls the fulfilment function on the APIConsumer contract. The fulfilment function simple emits a contract event with the cid of the audio file on Filecoin/IPFS and some additional audio file metadata rendered in the web UI.

## Jobspec

The Chainlink Jobspec `getYouTubeAudio.toml` orchestrates requests from the APIConsumer contract, the external adapter and the Chainlink node.

The Jobspec parses a number of parameters returned form the external adapter. As there are multiple parameters is differs from examples in the official Chainlink documentation. It also handles strings longer than 32 bytes.

## External Adapter

This was generated by modifying the template provided here:

https://github.com/thodges-gh/CL-EA-NodeJS-Template

The `index.js` file holds the custom aspects of this adapter, particularly in the `createRequest` function.

The `youtube-dl-exec` package is used to download and extract the audio from a video. The `web3.storage` package is used to save the audio content to decentralised IPFS storage at Filecoin.

The api key for Web3.Storage needs to be set in a `.env` file. Rename `.env.example` and fill in `WEB3STORAGE_API_KEY`.

## Docker

A Chainlink node was hosted in order to develop this solution. The respective `Dockerfile` and `docker-compose.yml` files have been included.
